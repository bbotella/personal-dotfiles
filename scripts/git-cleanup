#!/bin/bash

# Git Cleanup Script
# Removes merged branches and prunes remote tracking branches

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üßπ Git Repository Cleanup${NC}"
echo "================================"
echo

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}‚ùå Not in a git repository${NC}"
    exit 1
fi

# Get current branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo -e "${BLUE}üìç Current branch: ${YELLOW}$CURRENT_BRANCH${NC}"
echo

# Fetch latest changes
echo -e "${BLUE}üîÑ Fetching latest changes...${NC}"
git fetch --all --prune
echo

# Show branches that will be deleted
echo -e "${YELLOW}üîç Finding merged branches to delete...${NC}"
BRANCHES_TO_DELETE=$(git branch --merged | grep -v "\\*\\|main\\|master\\|develop\\|staging" | xargs -n 1 echo | tr -d ' ')

if [ -z "$BRANCHES_TO_DELETE" ]; then
    echo -e "${GREEN}‚úÖ No merged branches to delete${NC}"
else
    echo -e "${YELLOW}Branches that will be deleted:${NC}"
    echo "$BRANCHES_TO_DELETE" | sed 's/^/  - /'
    echo
    
    # Ask for confirmation
    read -p "Delete these branches? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${BLUE}üóëÔ∏è  Deleting merged branches...${NC}"
        echo "$BRANCHES_TO_DELETE" | xargs -n 1 git branch -d
        echo -e "${GREEN}‚úÖ Merged branches deleted${NC}"
    else
        echo -e "${YELLOW}‚è≠Ô∏è  Skipping branch deletion${NC}"
    fi
fi

echo

# Clean up remote tracking branches
echo -e "${BLUE}üßπ Cleaning up remote tracking branches...${NC}"
git remote prune origin
echo -e "${GREEN}‚úÖ Remote tracking branches cleaned${NC}"

echo

# Show repository status
echo -e "${BLUE}üìä Repository Status:${NC}"
echo -e "${YELLOW}Remaining branches:${NC}"
git branch -a | sed 's/^/  /'

echo
echo -e "${YELLOW}Recent commits:${NC}"
git log --oneline -n 5 | sed 's/^/  /'

echo
echo -e "${GREEN}‚úÖ Cleanup complete!${NC}"